<div class="container mt-5">
  <h2 class="fw-bold">Admin Panel â€“ Track Registered Driver Data</h2>

  <div class="card mt-4 p-4 shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">Registered Driver Data</h4>
      <button class="btn button" data-bs-toggle="modal" data-bs-target="#registerDriverModal">
        + Register Driver
      </button>
    </div>

    <!-- ðŸ”¹ Search Bar -->
    <div class="mb-3 d-flex gap-2">
      <input
        type="text"
        class="form-control"
        placeholder="Search by EV ID or Driver ID..."
        [(ngModel)]="searchQuery"
        (input)="applySearch()"
      />
      <button class="btn btn-outline-secondary" (click)="clearSearch()">Clear</button>
    </div>

    <!-- Table -->
    <table class="table table-bordered table-hover text-center align-middle">
      <thead class="table-light">
        <tr>
          <th (click)="sortTable('driver_id')">Driver-ID {{ getSortIcon('driver_id') }}</th>
          <th (click)="sortTable('name')">Driver Name {{ getSortIcon('name') }}</th>
          <th (click)="sortTable('contact_number')">Contact No {{ getSortIcon('contact_number') }}</th>
          <th (click)="sortTable('allocated_rikshaw')">Allocated Ev Id {{ getSortIcon('allocated_rikshaw') }}</th>
          <th (click)="sortTable('cnic_number')">CNIC {{ getSortIcon('cnic_number') }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let ev of paginatedData"
            (click)="openDetails(ev)"
            data-bs-toggle="modal"
            data-bs-target="#driverDetailModal"
            style="cursor:pointer">
          <td>{{ ev.evId || ev.driver_id }}</td>
          <td>{{ ev.name }}</td>
          <td>{{ ev.contact_number }}</td>
          <td>{{ ev.allocated_rikshaw }}</td>
          <td>{{ ev.cnic_number }}</td>
        </tr>
        <tr *ngIf="filteredData.length === 0">
          <td colspan="5" class="text-center text-muted">No data found.</td>
        </tr>
      </tbody>
    </table>

    <!-- Pagination -->
    <nav aria-label="Page navigation" class="mt-3">
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <a class="page-link" (click)="setPage(currentPage - 1)">Previous</a>
        </li>
        <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index"
          [class.active]="currentPage === (i + 1)">
          <a class="page-link" (click)="setPage(i + 1)">{{ i + 1 }}</a>
        </li>
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <a class="page-link" (click)="setPage(currentPage + 1)">Next</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<!-- ðŸ”¹ Driver Detail Modal -->
<div class="modal fade" id="driverDetailModal" tabindex="-1" aria-labelledby="driverDetailLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title" id="driverDetailLabel">Driver Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body" *ngIf="selectedDriver">
        <p><strong>Driver ID:</strong> {{ selectedDriver.evId || selectedDriver.driver_id }}</p>
        <p><strong>Name:</strong> {{ selectedDriver.name }}</p>
        <p><strong>Contact:</strong> {{ selectedDriver.contact_number }}</p>
        <p><strong>Allocated EV:</strong> {{ selectedDriver.allocated_rikshaw }}</p>
        <p><strong>CNIC:</strong> {{ selectedDriver.cnic_number }}</p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- ðŸ”¹ Register Driver Modal -->
<div class="modal fade" id="registerDriverModal" tabindex="-1" aria-labelledby="registerDriverLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title" id="registerDriverLabel">Register Driver</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form [formGroup]="driverForm" (ngSubmit)="onSubmit()">
        <div class="modal-body">
          <div class="row g-3">
            <!-- Full Name -->
            <div class="col-md-6">
              <input type="text" class="form-control"
                     formControlName="name" placeholder="Full Name" />
              <small class="text-danger" *ngIf="driverForm.get('name')?.invalid && driverForm.get('name')?.touched">
                Only letters allowed
              </small>
            </div>

            <!-- Contact Number -->
            <div class="col-md-6">
              <input type="text" class="form-control"
                     formControlName="contact_number" placeholder="Contact Number (11 digits)" maxlength="11" />
              <small class="text-danger" *ngIf="driverForm.get('contact_number')?.invalid && driverForm.get('contact_number')?.touched">
                Must be 11 digits
              </small>
            </div>

            <!-- DOB -->
            <div class="col-md-6">
              <input type="date" class="form-control" formControlName="dob" />
              <small class="text-danger" *ngIf="driverForm.get('dob')?.invalid && driverForm.get('dob')?.touched">
                Date of Birth required
              </small>
            </div>

            <!-- Current Address -->
            <div class="col-md-6">
              <input type="text" class="form-control"
                     formControlName="current_address" placeholder="Current Address" />
              <small class="text-danger" *ngIf="driverForm.get('current_address')?.invalid && driverForm.get('current_address')?.touched">
                Address must be at least 5 characters
              </small>
            </div>
          </div>

          <!-- Allocated Rikshaw ID & CNIC -->
          <div class="mt-4">
            <input type="text" class="form-control mb-2" placeholder="Allocated Rikshaw ID (e.g. RK005)" formControlName="allocated_rikshaw" />
            <small class="text-danger" *ngIf="driverForm.get('allocated_rikshaw')?.invalid && driverForm.get('allocated_rikshaw')?.touched">
              Format must be like RK005
            </small>

            <input type="text" class="form-control" formControlName="cnic_number" placeholder="Enter 13 Digit CNIC" maxlength="13" />
            <small class="text-danger" *ngIf="driverForm.get('cnic_number')?.invalid && driverForm.get('cnic_number')?.touched">
              CNIC must be 13 digits
            </small>
          </div>

          <!-- File Uploads -->
          <div class="mt-4">
            <label class="form-label">Driver Image</label>
            <input type="file" class="form-control mb-2" (change)="onFileSelect($event, 'driver_image')" />
            <small class="text-danger" *ngIf="imageErrors['driver_image']">{{ imageErrors['driver_image'] }}</small>

            <label class="form-label">CNIC Front</label>
            <input type="file" class="form-control mb-2" (change)="onFileSelect($event, 'cnic_front_image')" />
            <small class="text-danger" *ngIf="imageErrors['cnic_front_image']">{{ imageErrors['cnic_front_image'] }}</small>

            <label class="form-label">CNIC Back</label>
            <input type="file" class="form-control mb-2" (change)="onFileSelect($event, 'cnic_back_image')" />
            <small class="text-danger" *ngIf="imageErrors['cnic_back_image']">{{ imageErrors['cnic_back_image'] }}</small>

            <label class="form-label">License Image</label>
            <input type="file" class="form-control mb-2" (change)="onFileSelect($event, 'license_image')" />
            <small class="text-danger" *ngIf="imageErrors['license_image']">{{ imageErrors['license_image'] }}</small>

            <label class="form-label">Criminal Record Image</label>
            <input type="file" class="form-control" (change)="onFileSelect($event, 'criminal_record_image')" />
            <small class="text-danger" *ngIf="imageErrors['criminal_record_image']">{{ imageErrors['criminal_record_image'] }}</small>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn button">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>
